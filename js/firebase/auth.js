// Importando as fun√ß√µes do Firebase Auth
import { auth } from './config.js';
import { 
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  signOut,
  GoogleAuthProvider,
  FacebookAuthProvider,
  signInWithPopup,
  signInWithRedirect,
  getRedirectResult,
  sendPasswordResetEmail,
  updateProfile,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";

// Provedores para autentica√ß√£o social
const googleProvider = new GoogleAuthProvider();
// Configurar com par√¢metros mais b√°sicos para evitar problemas
googleProvider.addScope('email');
googleProvider.addScope('profile');
// Configura√ß√£o mais simples
googleProvider.setCustomParameters({
  prompt: 'select_account'
});

const facebookProvider = new FacebookAuthProvider();
// Adicionar escopos para Facebook (opcional)
facebookProvider.addScope('email');
facebookProvider.addScope('public_profile');

// Fun√ß√£o para criar um novo usu√°rio com email e senha
export const registerWithEmailAndPassword = async (name, email, password) => {
  try {
    // Criar o usu√°rio
    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
    const user = userCredential.user;
    
    // Adicionar o nome de exibi√ß√£o ao usu√°rio
    await updateProfile(user, { displayName: name });
    
    console.log('Usu√°rio registrado com sucesso:', user);
    return user;
  } catch (error) {
    console.error('Erro ao registrar usu√°rio:', error);
    let errorMessage = 'Ocorreu um erro ao criar sua conta. Tente novamente.';
    
    if (error.code === 'auth/email-already-in-use') {
      errorMessage = 'Este email j√° est√° sendo usado por outra conta.';
    } else if (error.code === 'auth/weak-password') {
      errorMessage = 'A senha √© muito fraca. Use pelo menos 6 caracteres.';
    } else if (error.code === 'auth/invalid-email') {
      errorMessage = 'O email fornecido √© inv√°lido.';
    }
    
    throw new Error(errorMessage);
  }
};

// Fun√ß√£o para fazer login com email e senha
export const loginWithEmailAndPassword = async (email, password) => {
  try {
    const userCredential = await signInWithEmailAndPassword(auth, email, password);
    console.log('Login bem-sucedido:', userCredential.user);
    return userCredential.user;
  } catch (error) {
    console.error('Erro ao fazer login:', error);
    let errorMessage = 'Ocorreu um erro ao fazer login. Tente novamente.';
    
    if (error.code === 'auth/user-not-found') {
      errorMessage = 'Usu√°rio n√£o encontrado. Verifique seu email.';
    } else if (error.code === 'auth/wrong-password') {
      errorMessage = 'Senha incorreta. Tente novamente.';
    } else if (error.code === 'auth/invalid-email') {
      errorMessage = 'O email fornecido √© inv√°lido.';
    } else if (error.code === 'auth/user-disabled') {
      errorMessage = 'Esta conta foi desativada.';
    } else if (error.code === 'auth/too-many-requests') {
      errorMessage = 'Muitas tentativas de login. Tente novamente mais tarde.';
    }
    
    throw new Error(errorMessage);
  }
};

// Fun√ß√£o para verificar se a configura√ß√£o est√° correta
const verifyFirebaseConfig = () => {
  try {
    // Verificar se a configura√ß√£o b√°sica existe
    if (!auth || !auth.app) {
      throw new Error('Firebase Auth n√£o foi inicializado');
    }
    
    const config = auth.app.options;
    if (!config.apiKey || !config.authDomain || !config.projectId) {
      throw new Error('Configura√ß√£o do Firebase incompleta');
    }
    
    console.log('Configura√ß√£o Firebase verificada:', {
      apiKey: config.apiKey ? 'OK' : 'MISSING',
      authDomain: config.authDomain || 'MISSING',
      projectId: config.projectId || 'MISSING'
    });
    
    return true;
  } catch (error) {
    console.error('Erro na verifica√ß√£o da configura√ß√£o:', error);
    return false;
  }
};

// Fun√ß√£o para fazer login com Google - vers√£o simplificada e mais robusta
export const signInWithGoogle = async () => {
  try {
    console.log('=== INICIANDO LOGIN COM GOOGLE ===');
    
    // Verificar configura√ß√£o primeiro
    if (!verifyFirebaseConfig()) {
      throw new Error('Configura√ß√£o do Firebase incorreta. Entre em contato com o administrador.');
    }
    
    // Log do ambiente
    console.log('Dom√≠nio atual:', window.location.hostname);
    console.log('URL completa:', window.location.href);
    console.log('User Agent:', navigator.userAgent);
    
    // Limpar estado anterior
    sessionStorage.removeItem('googleAuthAttempt');
    
    // Verificar se estamos em um ambiente seguro (HTTPS ou localhost)
    const isSecure = window.location.protocol === 'https:' || 
                    window.location.hostname === 'localhost' || 
                    window.location.hostname === '127.0.0.1';
    
    if (!isSecure && window.location.hostname !== 'localhost') {
      throw new Error('A autentica√ß√£o com Google requer uma conex√£o segura (HTTPS).');
    }
    
    // Tentar popup primeiro
    try {
      console.log('Tentando autentica√ß√£o via popup...');
      
      // Criar um novo provider a cada tentativa para evitar cache
      const freshGoogleProvider = new GoogleAuthProvider();
      freshGoogleProvider.addScope('email');
      freshGoogleProvider.addScope('profile');
      freshGoogleProvider.setCustomParameters({
        prompt: 'select_account'
      });
      
      const result = await signInWithPopup(auth, freshGoogleProvider);
      
      if (result && result.user) {
        console.log('‚úÖ Login Google bem-sucedido:', result.user.email);
        return result.user;
      } else {
        throw new Error('Resposta inv√°lida do Google');
      }
      
    } catch (popupError) {
      console.error('‚ùå Erro no popup:', popupError);
      
      // An√°lise detalhada do erro
      if (popupError.code === 'auth/popup-blocked') {
        console.log('üö´ Popup bloqueado pelo navegador');
        throw new Error('O popup foi bloqueado pelo navegador. Permita popups para este site e tente novamente.');
      } else if (popupError.code === 'auth/popup-closed-by-user') {
        console.log('üö´ Popup fechado pelo usu√°rio');
        throw new Error('A janela de login foi fechada. Tente novamente.');
      } else if (popupError.code === 'auth/cancelled-popup-request') {
        console.log('üö´ Solicita√ß√£o de popup cancelada');
        throw new Error('Login cancelado. Tente novamente.');
      } else if (popupError.code === 'auth/unauthorized-domain') {
        const domain = window.location.hostname;
        console.error('üö´ Dom√≠nio n√£o autorizado:', domain);
        throw new Error(`Este dom√≠nio (${domain}) n√£o est√° autorizado no Firebase. Configure o dom√≠nio no Console do Firebase.`);
      } else if (popupError.code === 'auth/operation-not-allowed') {
        console.error('üö´ Opera√ß√£o n√£o permitida');
        throw new Error('A autentica√ß√£o com Google n√£o est√° habilitada. Configure no Console do Firebase.');
      } else if (popupError.code === 'auth/internal-error') {
        console.error('üö´ Erro interno do Firebase');
        throw new Error('Erro de configura√ß√£o do Firebase. Verifique as credenciais no Console.');
      } else {
        // Para outros erros, propagar a mensagem original
        throw new Error(popupError.message || 'Erro desconhecido durante a autentica√ß√£o.');
      }
    }
    
  } catch (error) {
    console.error('=== ERRO FINAL ===');
    console.error('C√≥digo:', error.code);
    console.error('Mensagem:', error.message);
    console.error('Stack:', error.stack);
    
    // Retornar erro mais amig√°vel
    throw new Error(error.message || 'N√£o foi poss√≠vel fazer login com o Google. Tente novamente mais tarde.');
  }
};

// Fun√ß√£o para verificar resultado de redirecionamento
export const checkRedirectResult = async () => {
  try {
    console.log('Verificando resultado de redirecionamento...');
    // Verificar se t√≠nhamos uma tentativa de login pendente
    const authAttempt = sessionStorage.getItem('googleAuthAttempt');
    
    // Log para diagn√≥stico
    console.log('Tentativa de autentica√ß√£o detectada:', authAttempt ? 'Sim' : 'N√£o');
    
    try {
      // Obter resultado do redirecionamento
      console.log('Chamando getRedirectResult...');
      const result = await getRedirectResult(auth);
      console.log('Resultado do redirecionamento:', result ? 'Obtido' : 'Nulo');
      
      // Limpar flag de tentativa de login
      sessionStorage.removeItem('googleAuthAttempt');
      
      if (result && result.user) {
        console.log('Login por redirecionamento bem-sucedido:', result.user.email);
        // Verifica se possui credenciais para Google (diagn√≥stico)
        if (GoogleAuthProvider.credentialFromResult(result)) {
          console.log('Credenciais Google v√°lidas obtidas');
        }
        return result.user;
      } else if (authAttempt) {
        // Se t√≠nhamos uma tentativa, mas n√£o temos resultado, provavelmente houve um erro
        console.warn('Tentativa de login detectada, mas sem resultado. Poss√≠vel erro ou cancelamento pelo usu√°rio.');
        // Em alguns casos o Firebase n√£o retorna erro, apenas resultado nulo
        if (window.location.href.includes('firebaseError')) {
          const errorParam = new URLSearchParams(window.location.search).get('firebaseError');
          console.error('Erro detectado na URL:', errorParam);
        }
      }
      return null;
    } catch (redirectError) {
      console.error('Erro ao processar getRedirectResult:', redirectError);
      
      // Tratar o erro espec√≠fico
      if (redirectError.code === 'auth/credential-already-in-use') {
        console.warn('Credencial j√° em uso. Poss√≠vel conflito de contas.');
        throw new Error('Este email do Google j√° est√° sendo usado por outra conta. Tente fazer login diretamente.');
      }
      
      // Propagar o erro para ser tratado no catch principal
      throw redirectError;
    }
  } catch (error) {
    console.error('Erro ao processar resultado do redirecionamento:', error);
    console.error('C√≥digo:', error.code);
    console.error('Mensagem:', error.message);
    
    // Limpar flag de tentativa
    sessionStorage.removeItem('googleAuthAttempt');
    
    // Verificar problemas espec√≠ficos de configura√ß√£o
    if (error.code === 'auth/unauthorized-domain') {
      const currentDomain = window.location.hostname;
      throw new Error(`Este site (${currentDomain}) n√£o est√° autorizado no Firebase Console. Entre em contato com o administrador.`);
    } else if (error.code === 'auth/operation-not-allowed') {
      throw new Error('A autentica√ß√£o com Google n√£o est√° habilitada no Firebase Console. Entre em contato com o administrador.');
    } else if (error.code === 'auth/credential-already-in-use') {
      throw new Error('Este email do Google j√° est√° sendo usado por outra conta. Tente fazer login diretamente.');
    } else {
      throw new Error(`Erro ao processar login: ${error.message}`);
    }
  }
};

// Fun√ß√£o para fazer login com Facebook
export const signInWithFacebook = async () => {
  try {
    console.log('Iniciando login com Facebook...');
    const result = await signInWithPopup(auth, facebookProvider);
    console.log('Login Facebook bem-sucedido:', result.user);
    return result.user;
  } catch (error) {
    console.error('Erro ao fazer login com Facebook:', error);
    console.log('C√≥digo de erro:', error.code);
    console.log('Mensagem de erro:', error.message);
    
    // Tentar m√©todo alternativo com redirecionamento se o popup falhar
    try {
      console.log('Tentando m√©todo alternativo com redirecionamento...');
      await signInWithRedirect(auth, facebookProvider);
      return null;
    } catch (redirectError) {
      console.error('Erro ao fazer login com Facebook (redirect):', redirectError);
      throw new Error('N√£o foi poss√≠vel fazer login com o Facebook. Tente novamente.');
    }
  }
};

// Fun√ß√£o para fazer logout
export const logoutUser = async () => {
  try {
    await signOut(auth);
    console.log('Usu√°rio desconectado com sucesso');
    return true;
  } catch (error) {
    console.error('Erro ao fazer logout:', error);
    throw new Error('Erro ao fazer logout. Tente novamente.');
  }
};

// Fun√ß√£o para enviar email de redefini√ß√£o de senha
export const resetPassword = async (email) => {
  try {
    await sendPasswordResetEmail(auth, email);
    console.log('Email de redefini√ß√£o de senha enviado');
    return true;
  } catch (error) {
    console.error('Erro ao enviar email de redefini√ß√£o:', error);
    let errorMessage = 'Erro ao enviar email de redefini√ß√£o de senha.';
    
    if (error.code === 'auth/invalid-email') {
      errorMessage = 'Email inv√°lido.';
    } else if (error.code === 'auth/user-not-found') {
      errorMessage = 'N√£o existe uma conta com este email.';
    }
    
    throw new Error(errorMessage);
  }
};

// Fun√ß√£o para verificar o estado de autentica√ß√£o do usu√°rio
export const getCurrentUser = () => {
  return new Promise((resolve, reject) => {
    const unsubscribe = onAuthStateChanged(auth, (user) => {
      unsubscribe();
      resolve(user);
    }, reject);
  });
};